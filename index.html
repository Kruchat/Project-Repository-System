<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">

    <title>ระบบคลังโปรเจค (v3 - AI Chat UX)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: { 
                        brand: { 500: '#0ea5e9', 600: '#0284c7' }, 
                        accent: { 500: '#10b981', 600: '#059669' }, 
                        ai: { 500: '#8b5cf6', 600: '#7c3aed' },
                        google: { 500: '#fbbc05', 600: '#ea4335' }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'pulse-dot': 'pulseDot 1.4s infinite ease-in-out both', 
                        'fade-in': 'fadeIn 0.3s ease-out'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        pulseDot: {
                            '0%, 80%, 100%': { transform: 'scale(0)', opacity: 0.5 },
                            '40%': { transform: 'scale(1.0)', opacity: 1 }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; height: 100dvh; width: 100vw; 
            overflow: hidden; display: flex; align-items: center; justify-content: center; font-family: 'Sarabun', sans-serif; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #app-shell { 
            width: 100%; height: 100%; background: #f8fafc; position: relative; overflow: hidden; 
            display: flex; flex-direction: column; 
        }
        @media (min-width: 768px) { 
            #app-shell { 
                max-width: 420px; height: 850px; max-height: 90dvh; border-radius: 40px; 
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); border: 4px solid #e2e8f0; 
            } 
        }
        
        /* Bottom Nav (v2) */
        .bottom-nav {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-top: 1px solid rgba(0,0,0,0.05);
            display: grid; grid-template-columns: 1fr 1fr 64px 1fr 1fr; /* 5 columns layout */
            position: relative; z-index: 50; padding: 8px 8px 0 8px;
            padding-bottom: env(safe-area-inset-bottom, 8px);
            align-items: center;
        }
        .nav-item {
            text-align: center; padding: 10px 5px; font-size: 11px; font-weight: 600; color: #64748b; 
            z-index: 2; cursor: pointer; transition: all 0.2s; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .nav-item.active { color: #0284c7; background-color: #f0f9ff; }
        #nav-chat.active { color: #7c3aed; background-color: #f5f3ff; }
        #nav-settings.active { color: #52525b; background-color: #f4f4f5; }
        .nav-item i { font-size: 16px; line-height: 1; }
        #nav-add-btn {
            width: 56px; height: 56px; border-radius: 99px;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px -5px rgba(14, 165, 233, 0.5);
            margin-bottom: 12px; /* Lift it up */
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 4px solid white;
        }
        #nav-add-btn:active { transform: scale(0.9); }

        /* Form Styles */
        .form-label { display: block; text-transform: uppercase; font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 6px; letter-spacing: 0.5px; }
        .form-input, .form-textarea, .form-select { width: 100%; background: white; border: 1px solid #cbd5e1; border-radius: 12px; padding: 10px 14px; font-size: 14px; color: #1e293b; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #0ea5e9; box-shadow: 0 0 0 3px #bfdbfe; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 20px; border-radius: 14px; font-size: 14px; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-primary { background-color: #0ea5e9; color: white; }
        .btn-primary:hover { background-color: #0284c7; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed; inset: 0; z-index: 1000;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-container {
            position: fixed; z-index: 1001;
            bottom: 0; left: 0; right: 0;
            background-color: #f8fafc;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0) + 24px);
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-close-btn {
            position: absolute; top: 16px; right: 16px;
            width: 32px; height: 32px; border-radius: 99px;
            background-color: #e2e8f0; color: #64748b;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        @media (min-width: 768px) {
            .modal-container {
                left: 50%; bottom: auto; top: 50%;
                transform: translate(-50%, -50%);
                max-width: 420px; width: 100%;
                border-radius: 24px;
                animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            .modal-backdrop { background-color: rgba(0, 0, 0, 0.4); }
        }

        /* --- [ใหม่] Chat UX/UI Styles --- */

        #view-chat { 
            display: none; /* [แก้ไข] เริ่มต้นด้วย none */
            flex-direction: column; height: 100%; padding: 0; 
            background-color: #f1f5f9; 
        }
        #chat-message-container { 
            flex: 1; overflow-y: auto; padding: 16px; 
            display: flex; flex-direction: column; gap: 12px; 
        }
        .chat-bubble { max-width: 85%; padding: 10px 16px; border-radius: 20px; font-size: 15px; line-height: 1.6; word-wrap: break-word; }
        .chat-bubble-user { background-color: #0ea5e9; color: white; border-bottom-right-radius: 5px; align-self: flex-end; }
        .chat-bubble-ai { 
            background-color: #ffffff; 
            color: #334155; border: 1px solid #e2e8f0; 
            border-bottom-left-radius: 5px; align-self: flex-start; 
            display: flex; gap: 10px; align-items: flex-start; 
        }
        .chat-bubble-ai i { color: #8b5cf6; padding-top: 5px; }
        
        /* [ใหม่] AI Rich Content Formatting */
        .chat-bubble-ai .chat-content { display: flex; flex-direction: column; width: 100%; overflow: hidden; }
        .chat-bubble-ai .chat-content b { font-weight: 600; }
        .chat-bubble-ai .chat-content ul { list-style: disc; padding-left: 20px; margin-top: 8px; margin-bottom: 8px; }
        .chat-bubble-ai .chat-content li { margin-bottom: 4px; }

        /* [ใหม่] AI Code Block */
        .chat-bubble-ai pre {
            background-color: #1e293b; /* Dark background */
            color: #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 4px;
            font-size: 13px;
            overflow-x: auto; /* Allow scrolling for wide code */
            position: relative;
        }
        .chat-bubble-ai code {
            font-family: monospace;
            white-space: pre;
        }
        .code-copy-btn {
            position: absolute;
            top: 8px; right: 8px;
            background-color: #334155;
            color: #94a3b8;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
        }
        .chat-bubble-ai pre:hover .code-copy-btn { opacity: 1; }
        .code-copy-btn:hover { background-color: #475569; color: white; }
        .code-copy-btn:active { transform: scale(0.95); }

        /* [ใหม่] AI Error & Retry */
        .chat-bubble-ai-error {
            background-color: #fff1f2;
            border-color: #fecaca;
            color: #b91c1c;
            align-items: flex-start;
        }
        .chat-bubble-ai-error i { color: #dc2626; }
        .chat-retry-btn {
            background-color: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-retry-btn:hover { background-color: #b91c1c; }


        #chat-form-container {
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            padding: 16px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0) + 16px);
        }
        #image-preview-container {
            position: relative;
            display: none; 
            margin-bottom: 12px;
            max-width: 100px; /* Smaller preview */
        }
        #image-preview-container img {
            width: 100px; height: 100px; object-fit: cover;
            border-radius: 12px; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        #remove-image-btn {
            position: absolute; top: -10px; right: -10px;
            width: 28px; height: 28px; border-radius: 99px;
            background-color: #334155; color: white; border: 2px solid white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #chat-input-row { display: flex; gap: 10px; align-items: flex-end; }
        #chat-input { 
            flex: 1; background-color: white; border: 1px solid #cbd5e1; 
            border-radius: 16px; padding: 12px 18px; font-size: 15px; 
            transition: all 0.2s; resize: none; max-height: 120px; 
        }
        #chat-input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px #ddd6fe; }
        .chat-btn {
            width: 48px; height: 48px; border-radius: 99px;
            color: white; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: all 0.2s;
        }
        #attach-btn { background-color: #94a3b8; }
        #attach-btn:hover { background-color: #64748b; }
        
        /* [ใหม่] Send/Stop Button Toggle */
        #chat-send-btn-container { position: relative; width: 48px; height: 48px; }
        #chat-send-btn, #chat-stop-btn {
            position: absolute; top: 0; left: 0;
            width: 48px; height: 48px; border-radius: 99px;
            color: white; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #chat-send-btn { background-color: #8b5cf6; transform: scale(1); opacity: 1; }
        #chat-send-btn:hover { background-color: #7c3aed; }
        #chat-send-btn:disabled { background-color: #c4b5fd; cursor: not-allowed; opacity: 0.7; }
        #chat-stop-btn { background-color: #dc2626; transform: scale(0.5); opacity: 0; pointer-events: none; }
        #chat-stop-btn:hover { background-color: #b91c1c; }
        #chat-stop-btn.active { transform: scale(1); opacity: 1; pointer-events: auto; }
        #chat-send-btn.hidden { transform: scale(0.5); opacity: 0; pointer-events: none; }
        
        #attach-btn:disabled { background-color: #cbd5e1; cursor: not-allowed; opacity: 0.7; }
        #chat-input:disabled { background-color: #f1f5f9; }
        
        /* Typing Indicator */
        .chat-bubble-ai-typing { background-color: #ffffff; color: #334155; border: 1px solid #e2e8f0; border-bottom-left-radius: 5px; align-self: flex-start; display: flex; gap: 10px; align-items: center; padding: 14px 16px; }
        .typing-dot { width: 8px; height: 8px; background-color: #94a3b8; border-radius: 50%; animation: pulseDot 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* [ใหม่] Suggested Prompts */
        #suggested-prompts-container {
            padding: 0 16px 16px 16px; /* Added to chat container */
            display: flex;
            flex-direction: column;
            gap: 8px;
            animation: fadeIn 0.5s ease-out;
        }
        .suggested-prompt {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .suggested-prompt:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }
        .suggested-prompt i {
            color: #94a3b8;
        }
        
    </style>
</head>
<body>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[6000] opacity-0 pointer-events-none transition-all duration-300 translate-y-[-20px] bg-slate-800/95 text-white px-5 py-3 rounded-full shadow-xl backdrop-blur-md flex items-center gap-3 text-sm font-medium border border-slate-700/50">
        <i id="toast-icon" class="fa-solid fa-check-circle text-emerald-400"></i>
        <span id="toast-msg">สำเร็จ</span>
    </div>

    <!-- File Inputs -->
    <input type="file" id="import-file-input" class="hidden" accept=".json, .txt" onchange="window.handleFileImport(event)">
    <input type="file" id="image-upload-input" class="hidden" accept="image/png, image/jpeg" onchange="window.handleImageUpload(event)">

    <!-- Project Add/Edit Modal -->
    <div id="project-modal-container" class="hidden">
        <div class="modal-backdrop" onclick="window.hideProjectModal()"></div>
        <div class="modal-container">
            <button onclick="window.hideProjectModal()" class="modal-close-btn"><i class="fa-solid fa-times"></i></button>
            <h3 id="modal-title" class="text-xl font-bold text-slate-800 mb-6">...</h3>
            
            <form id="project-form" onsubmit="window.handleSaveProject(event); return false;" class="space-y-4">
                <input type="hidden" id="form-project-id">
                
                <div>
                    <label for="form-title" class="form-label">ชื่อโปรเจค</label>
                    <input type="text" id="form-title" class="form-input" placeholder="เช่น ระบบตารางเวรครู AI" required>
                </div>
                
                <div>
                    <label for="form-category" class="form-label">หมวดหมู่</label>
                    <input type="text" id="form-category" class="form-input" placeholder="เช่น Tools, App, Website">
                </div>
                
                <div>
                    <label for="form-url" class="form-label">URL (ลิงก์)</label>
                    <input type="url" id="form-url" class="form-input" placeholder="https://...">
                </div>
                
                <div>
                    <label for="form-description" class="form-label">คำอธิบาย</label>
                    <textarea id="form-description" class="form-textarea" rows="3" placeholder="รายละเอียดโปรเจคโดยย่อ..."></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button id="form-delete-btn" type="button" onclick="window.confirmDeleteProject()" class="btn btn-danger hidden">
                        <i class="fa-solid fa-trash mr-2"></i> ลบ
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-save mr-2"></i> บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-modal-container" class="hidden">
        <div class="modal-backdrop" onclick="window.hideConfirmModal()"></div>
        <div class="modal-container">
             <h3 class="text-xl font-bold text-slate-800 mb-4">ยืนยันการลบ</h3>
             <p class="text-slate-600 mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบโปรเจคนี้? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
             <div class="grid grid-cols-2 gap-3">
                <button onclick="window.hideConfirmModal()" class="btn btn-secondary">ยกเลิก</button>
                <button onclick="window.executeDelete()" class="btn btn-danger">ยืนยันการลบ</button>
             </div>
        </div>
    </div>


    <main id="app-shell">

        <!-- Header -->
        <header class="px-6 py-4 flex justify-between items-center sticky top-0 shadow-sm bg-white/80 z-40 backdrop-blur-md border-b border-slate-100/80">
            <div class="flex flex-col">
                <h1 class="text-xl font-bold text-brand-600">Project Repo</h1>
                <p id="header-subtitle" class="text-sm text-slate-500">v3 - AI Chat UX</p>
            </div>
            <div id="header-icon-container" class="w-12 h-12 bg-sky-100 rounded-full flex items-center justify-center text-sky-600 border-4 border-white shadow-md">
                <i id="header-icon" class="fa-solid fa-home text-xl"></i>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto no-scrollbar pb-6">
            
            <!-- View 1: Home -->
            <section id="view-home" class="p-6" style="display: none;"> <!-- [แก้ไข] style="display: none;" -->
                <div class="bg-gradient-to-br from-brand-500 to-brand-600 text-white p-6 rounded-3xl shadow-xl shadow-sky-200 animate-scale-in mb-6">
                    <span class="text-sm font-light opacity-80" id="today-date">...</span>
                    <h2 class="text-2xl font-bold tracking-tight mt-1 mb-4">คลังโปรเจค AI</h2>
                    <p class="font-light text-sky-100 opacity-90">
                        ยินดีต้อนรับ! ใช้ปุ่ม <i class="fa-solid fa-plus mx-1"></i> ด้านล่างเพื่อเพิ่มโปรเจคใหม่ หรือไปที่แท็บ <i class="fa-solid fa-wand-magic-sparkles mx-1"></i> เพื่อสั่งการ AI
                    </p>
                </div>
                <h3 class="text-lg font-bold text-slate-700 mb-3 px-1">เมนูด่วน</h3>
                <div class="grid grid-cols-2 gap-4">
                     <button onclick="window.switchView('view-projects')" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 hover:border-brand-300 hover:bg-sky-50 transition">
                        <i class="fa-solid fa-list-check text-brand-500 text-2xl"></i>
                        <span class="text-sm font-semibold text-slate-700">โปรเจคทั้งหมด</span>
                    </button>
                    <button onclick="window.switchView('view-chat')" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 hover:border-ai-300 hover:bg-violet-50 transition">
                        <i class="fa-solid fa-wand-magic-sparkles text-ai-500 text-2xl"></i>
                        <span class="text-sm font-semibold text-slate-700">แชทกับ AI</span>
                    </button>
                </div>
            </section>

            <!-- View 2: Project List -->
            <section id="view-projects" class="p-6 space-y-4" style="display: none;"> <!-- [แก้ไข] style="display: none;" -->
                <div class="relative">
                    <input type="text" id="input-search" oninput="window.renderProjectList()" class="form-input pl-10" placeholder="ค้นหาโปรเจค...">
                    <i class="fa-solid fa-search text-slate-400 absolute top-1/2 left-3.5 -translate-y-1/2"></i>
                </div>
                <div id="project-list-container" class="space-y-3">
                    <!-- JS populates this -->
                </div>
            </section>

            <!-- View 3: Chat AI -->
            <section id="view-chat" style="display: none;"> <!-- [แก้ไข] style="display: none;" -->
                <!-- [ใหม่] Suggested Prompts จะถูกใส่ที่นี่โดย JS -->
                <div id="suggested-prompts-container"></div>
                
                <div id="chat-message-container" class="no-scrollbar">
                    <!-- JS populates this -->
                </div>
                <div id="chat-form-container">
                    <div id="image-preview-container">
                        <!-- JS populates this -->
                    </div>
                    <form id="chat-form">
                        <div id="chat-input-row">
                            <button id="attach-btn" type="button" class="chat-btn" onclick="window.triggerImageUpload()">
                                <i class="fa-solid fa-paperclip"></i>
                            </button>
                            <textarea id="chat-input" placeholder="พิมพ์คำสั่งหรือแนบรูปภาพ..." rows="1"></textarea>
                            
                            <!-- [ใหม่] Send/Stop Button Container -->
                            <div id="chat-send-btn-container">
                                <button id="chat-send-btn" type="submit" class="chat-btn">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                                <button id="chat-stop-btn" type="button" class="chat-btn">
                                    <i class="fa-solid fa-stop"></i>
                                </button>
                            </div>

                        </div>
                    </form>
                </div>
            </section>

            <!-- View 4: Settings -->
            <section id="view-settings" class="p-6 space-y-6" style="display: none;"> <!-- [แก้ไข] style="display: none;" -->
                
                <!-- Google Sheet Sync -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">Google Sheet Sync</h3>
                        <i class="fa-brands fa-google-drive text-2xl text-google-500"></i>
                    </div>
                    <div>
                        <label for="input-apps-script-url" class="form-label">Google Apps Script URL</label>
                        <input type="url" id="input-apps-script-url" class="form-input" placeholder="https://script.google.com/macros/s/..." oninput="window.saveAppsScriptUrl(this.value)">
                    </div>
                    <p class="text-sm text-slate-600 mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                        <i class="fa-solid fa-circle-info mr-1 text-green-600"></i>
                        ระบบจะ Sync อัตโนมัติเมื่อมีการเปลี่ยนแปลงข้อมูล
                    </p>
                </div>
                
                <!-- Import/Export -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">นำเข้า / ส่งออก ข้อมูล</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.exportBackup()" class="btn btn-secondary">
                            <i class="fa-solid fa-download mr-2"></i> บันทึกลงเครื่อง
                        </button>
                        <button onclick="window.triggerImport()" class="btn btn-secondary">
                            <i class="fa-solid fa-upload mr-2"></i> นำเข้าจากเครื่อง
                        </button>
                    </div>
                </div>

                <!-- AI Settings -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">ตั้งค่า AI</h3>
                    <div>
                        <label for="input-api-key" class="form-label">Gemini API Key</label>
                        <div class="relative">
                            <input type="password" id="input-api-key" class="form-input pr-10" placeholder="กรอก API Key ของคุณ" oninput="window.saveApiKey(this.value)">
                            <button onclick="window.toggleKeyVisibility()" class="absolute top-1/2 right-3 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                                <i id="api-key-eye" class="fa-solid fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="input-ai-model" class="form-label">AI Model</label>
                        <select id="input-ai-model" class="form-select" onchange="window.saveAiModel(this.value)">
                            <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash (Preview)</option>
                            <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Latest)</option>
                            <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Latest)</option>
                        </select>
                    </div>
                </div>
                
                <!-- JSON Data -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">จัดการข้อมูล (JSON)</h3>
                    <div>
                        <label for="input-project-data-json" class="form-label">ข้อมูลโปรเจค (JSON Array)</label>
                        <textarea id="input-project-data-json" class="form-textarea" rows="8"></textarea>
                    </div>
                    <button onclick="window.saveProjectsDataFromJson()" class="btn btn-secondary w-full mt-4">
                        <i class="fa-solid fa-save mr-2"></i> บันทึกข้อมูล
                    </button>
                </div>

            </section>
        </div>

        <!-- Bottom Nav -->
        <nav id="bottom-nav" class="bottom-nav shrink-0">
            <div id="nav-home" class="nav-item active" onclick="window.switchView('view-home')">
                <i class="fa-solid fa-house"></i>
                <span>หน้าหลัก</span>
            </div>
            <div id="nav-projects" class="nav-item" onclick="window.switchView('view-projects')">
                <i class="fa-solid fa-list-check"></i>
                <span>โปรเจค</span>
            </div>
            
            <!-- Add Button -->
            <div class="flex items-center justify-center">
                 <button id="nav-add-btn" onclick="window.showProjectModal()">
                    <i class="fa-solid fa-plus text-lg"></i>
                </button>
            </div>
           
            <!-- Chat AI -->
            <div id="nav-chat" class="nav-item" onclick="window.switchView('view-chat')">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span>แชท AI</span>
            </div>

            <!-- Settings -->
            <div id="nav-settings" class="nav-item" onclick="window.switchView('view-settings')">
                <i class="fa-solid fa-sliders"></i>
                <span>ตั้งค่า</span>
            </div>
        </nav>
    </main>

    <script type="module">
        // --- STATE & DOM ---
        let state = {
            projects: [],
            // [ใหม่] Chat History
            chatHistory: [], 
            isAiThinking: false,
            attachedFile: { base64: null, mimeType: null, dataUrl: null },
            pendingDeleteId: null,
            currentView: 'view-home'
        };
        
        // [ใหม่] สำหรับ AbortController
        let currentAIController = null;

        const dom = {
            views: { 
                home: document.getElementById('view-home'), 
                projects: document.getElementById('view-projects'), 
                chat: document.getElementById('view-chat'), 
                settings: document.getElementById('view-settings') 
            },
            nav: { 
                home: document.getElementById('nav-home'), 
                projects: document.getElementById('nav-projects'), 
                chat: document.getElementById('nav-chat'), 
                settings: document.getElementById('nav-settings') 
            },
            headerSubtitle: document.getElementById('header-subtitle'),
            headerIconContainer: document.getElementById('header-icon-container'), 
            headerIcon: document.getElementById('header-icon'), 
            todayDate: document.getElementById('today-date'),
            
            projectListContainer: document.getElementById('project-list-container'),
            inputSearch: document.getElementById('input-search'),
            
            projectModalContainer: document.getElementById('project-modal-container'),
            modalTitle: document.getElementById('modal-title'),
            form: document.getElementById('project-form'),
            formProjectId: document.getElementById('form-project-id'),
            formTitle: document.getElementById('form-title'),
            formCategory: document.getElementById('form-category'),
            formUrl: document.getElementById('form-url'),
            formDescription: document.getElementById('form-description'),
            formDeleteBtn: document.getElementById('form-delete-btn'),
            
            confirmModalContainer: document.getElementById('confirm-modal-container'),
            
            toast: document.getElementById('toast'),
            toastIcon: document.getElementById('toast-icon'),
            toastMsg: document.getElementById('toast-msg'),

            importFileInput: document.getElementById('import-file-input'),
            inputProjectDataJson: document.getElementById('input-project-data-json'),
            
            inputApiKey: document.getElementById('input-api-key'),
            inputAiModel: document.getElementById('input-ai-model'),
            apiKeyEye: document.getElementById('api-key-eye'),
            inputAppsScriptUrl: document.getElementById('input-apps-script-url'),
            
            // [ใหม่] Chat DOMs
            chatMessageContainer: document.getElementById('chat-message-container'),
            suggestedPromptsContainer: document.getElementById('suggested-prompts-container'),
            chatForm: document.getElementById('chat-form-container'), 
            chatInput: document.getElementById('chat-input'),
            chatSendBtn: document.getElementById('chat-send-btn'),
            chatStopBtn: document.getElementById('chat-stop-btn'),
            attachBtn: document.getElementById('attach-btn'),
            imageUploadInput: document.getElementById('image-upload-input'),
            imagePreviewContainer: document.getElementById('image-preview-container'),
        };

        // --- INITIALIZATION ---
        function initApp() {
            loadProjectsData();
            loadChatHistory(); // [ใหม่]
            loadApiKey();
            loadAiModel();
            loadAppsScriptUrl(); 
            
            switchView('view-home'); 
            
            // [ใหม่] Chat Listeners
            dom.chatInput.addEventListener('input', () => {
                dom.chatInput.style.height = 'auto'; 
                dom.chatInput.style.height = `${dom.chatInput.scrollHeight}px`;
            });
            dom.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('chat-form').dispatchEvent(new Event('submit', { cancelable: true }));
                }
            });
            document.getElementById('chat-form').addEventListener('submit', sendChatMessage);
            dom.chatStopBtn.addEventListener('click', stopAIGeneration); // [ใหม่]
        }

        // --- NAVIGATION & UTILS ---
        
        /**
         * [แก้ไข] เขียนฟังก์ชัน switchView ใหม่ทั้งหมด
         * เพื่อแก้บั๊กการแสดงผลทับซ้อนของเมนู
         */
        function switchView(id) {
            state.currentView = id;

            // [FIX 1] ซ่อนทุก Views ทั้งหมดก่อน โดยตั้งค่า display: 'none'
            Object.values(dom.views).forEach(el => {
                el.style.display = 'none';
            });
            
            // ค้นหา viewId และ navId (เช่น 'home', 'projects')
            const viewId = id.split('-')[1]; 

            // [FIX 2] แสดงผลเฉพาะ View ที่เลือก
            if (dom.views[viewId]) {
                if (viewId === 'chat') {
                    // หน้าแชทใช้ 'flex'
                    dom.views[viewId].style.display = 'flex'; 
                } else {
                    // หน้าอื่นใช้ 'block'
                    dom.views[viewId].style.display = 'block'; 
                }
            }
            
            // [FIX 3] จัดการ .active class ของ Nav
            // ลบ active ออกจากทุกปุ่ม
            Object.values(dom.nav).forEach(el => el.classList.remove('active'));
            // เพิ่ม active ให้ปุ่มที่ถูกคลิก
            if (dom.nav[viewId]) {
                dom.nav[viewId].classList.add('active');
            }
            
            // อัปเดต Header
            updateHeader(id);
            
            // เรียกฟังก์ชัน render ของแต่ละหน้า
            switch(id) {
                case 'view-home': renderHome(); break;
                case 'view-projects': renderProjectList(); break;
                case 'view-chat': renderChatHistory(); break; 
                case 'view-settings': renderSettings(); break;
            }
        }

        function updateHeader(id) {
            let subtitle = "หน้าหลัก";
            let iconClass = "fa-solid fa-home";
            let bgColor = "bg-sky-100";
            let textColor = "text-sky-600";

            switch(id) {
                case 'view-projects':
                    subtitle = "โปรเจคทั้งหมด";
                    iconClass = "fa-solid fa-list-check";
                    break;
                case 'view-chat':
                    subtitle = "ผู้ช่วย AI";
                    iconClass = "fa-solid fa-wand-magic-sparkles";
                    bgColor = "bg-violet-100";
                    textColor = "text-violet-600";
                    break;
                case 'view-settings':
                    subtitle = "ตั้งค่า & จัดการข้อมูล";
                    iconClass = "fa-solid fa-sliders";
                    bgColor = "bg-slate-100";
                    textColor = "text-slate-600";
                    break;
            }
            
            dom.headerSubtitle.textContent = subtitle;
            dom.headerIcon.className = `${iconClass} text-xl`;
            dom.headerIconContainer.className = `w-12 h-12 ${bgColor} ${textColor} rounded-full flex items-center justify-center border-4 border-white shadow-md`;
        }

        function showToast(msg, type='success') {
            dom.toastMsg.textContent = msg;
            dom.toastIcon.className = type==='success' ? "fa-solid fa-circle-check text-emerald-400" : "fa-solid fa-circle-exclamation text-rose-400";
            dom.toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => dom.toast.classList.add('opacity-0', 'translate-y-[-20px]'), 3000);
        }

        function getTodayString() {
            // วันที่ของระบบ
            return new Date().toLocaleDateString('th-TH', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
            });
        }
        
        function escapeHTML(str) {
            if (!str) return "";
            return str.replace(/[&<>"']/g, function(match) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
            });
        }

        // --- AI Settings Functions ---
        function saveApiKey(v) { localStorage.setItem('project_repo_api_key', v); };
        function loadApiKey() {
            const k = localStorage.getItem('project_repo_api_key');
            if (k) dom.inputApiKey.value = k;
        };
        function toggleKeyVisibility() {
            if (dom.inputApiKey.type === 'password') {
                dom.inputApiKey.type = 'text';
                dom.apiKeyEye.classList.remove('fa-eye-slash'); dom.apiKeyEye.classList.add('fa-eye');
            } else {
                dom.inputApiKey.type = 'password';
                dom.apiKeyEye.classList.remove('fa-eye'); dom.apiKeyEye.classList.add('fa-eye-slash');
            }
        };
        function saveAiModel(v) { localStorage.setItem('project_repo_ai_model', v); };
        function loadAiModel() {
             const m = localStorage.getItem('project_repo_ai_model');
             dom.inputAiModel.value = m || 'gemini-2.5-flash-preview-09-2025';
        };
        
        function saveAppsScriptUrl(v) { localStorage.setItem('project_repo_gas_url', v); };
        function loadAppsScriptUrl() {
            const url = localStorage.getItem('project_repo_gas_url');
            if (url) dom.inputAppsScriptUrl.value = url;
        };


        // --- DATA & RENDERING LOGIC ---
        
        function renderHome() {
            dom.todayDate.textContent = getTodayString();
        }
        
        function renderProjectList() {
            const searchTerm = dom.inputSearch.value.toLowerCase();
            
            const filteredProjects = state.projects.filter(p => 
                p.title.toLowerCase().includes(searchTerm) ||
                (p.category || "").toLowerCase().includes(searchTerm) ||
                (p.description || "").toLowerCase().includes(searchTerm)
            );

            if (filteredProjects.length === 0) {
                dom.projectListContainer.innerHTML = `<p class="text-center text-slate-500 mt-8">ไม่พบโปรเจค</p>`;
                return;
            }

            const groupedByCategory = filteredProjects.reduce((acc, p) => {
                const category = p.category || "ไม่มีหมวดหมู่";
                if (!acc[category]) acc[category] = [];
                acc[category].push(p);
                return acc;
            }, {});

            dom.projectListContainer.innerHTML = Object.keys(groupedByCategory).sort().map(category => {
                const projects = groupedByCategory[category];
                return `
                    <div class="mb-4">
                        <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2 px-1">${category}</h4>
                        <div class="space-y-2">
                            ${projects.map(p => `
                                <button onclick="window.showProjectModal('${p.id}')" class="w-full flex items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:border-brand-300 hover:bg-sky-50 transition text-left">
                                    <div class="w-10 h-10 bg-brand-100 text-brand-600 rounded-lg flex items-center justify-center mr-4 shrink-0">
                                        <i class="fa-solid ${p.url ? 'fa-link' : 'fa-lightbulb'}"></i>
                                    </div>
                                    <div class="flex-1 overflow-hidden">
                                        <p class="font-semibold text-slate-800 truncate">${p.title}</p>
                                        <p class="text-sm text-slate-500 truncate">${p.description || "ไม่มีคำอธิบาย"}</p>
                                    </div>
                                    ${p.url ? `<a href="${p.url}" target="_blank" onclick="event.stopPropagation()" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-brand-500 ml-2 shrink-0 rounded-full hover:bg-slate-100"><i class="fa-solid fa-external-link-alt"></i></a>` : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderSettings() {
            dom.inputProjectDataJson.value = JSON.stringify(state.projects, null, 2);
            loadApiKey();
            loadAiModel();
            loadAppsScriptUrl(); 
        }

        // --- DATA PERSISTENCE ---
        
        function loadProjectsData() {
            const data = localStorage.getItem('project_repository_data_v1');
            if (data) {
                try { state.projects = JSON.parse(data); } catch (e) { state.projects = []; }
            } else {
                state.projects = [
                    { id: "p1", title: "ระบบตารางเวรครู AI", category: "Tools", url: "https://example.com", description: "แอปสำหรับจัดตารางเวรด้วย AI" },
                    { id: "p2", title: "เว็บโรงเรียน", category: "Website", url: "https://school.com", description: "เว็บไซต์ประชาสัมพันธ์" }
                ];
            }
            sortProjects();
        }
        
        function saveProjectsToStorage() {
            try {
                localStorage.setItem('project_repository_data_v1', JSON.stringify(state.projects));
            } catch (e) { showToast('ไม่สามารถบันทึกข้อมูลได้ (อาจจะเต็ม)', 'error'); }
        }
        
        function sortProjects() {
            state.projects.sort((a, b) => (a.category || "").localeCompare(b.category || "") || a.title.localeCompare(b.title));
        }

        function loadChatHistory() {
            const data = localStorage.getItem('project_repo_chat_history_v1');
            if (data) {
                try { state.chatHistory = JSON.parse(data); } catch (e) { state.chatHistory = []; }
            } else { state.chatHistory = []; }
        }
        
        function saveChatHistory() {
            try {
                const recentHistory = state.chatHistory.slice(-50);
                localStorage.setItem('project_repo_chat_history_v1', JSON.stringify(recentHistory));
            } catch (e) { console.error("Failed to save chat history:", e); }
        }

        function saveProjectsDataFromJson() {
            try {
                const newData = JSON.parse(dom.inputProjectDataJson.value);
                if (Array.isArray(newData)) {
                    state.projects = newData;
                    sortProjects();
                    saveProjectsToStorage();
                    showToast('บันทึกข้อมูลเรียบร้อยแล้ว');
                    renderHome(); renderProjectList();
                    triggerAutoSync(); // Auto-sync
                } else { showToast('รูปแบบข้อมูลไม่ถูกต้อง (ต้องเป็น Array)', 'error'); }
            } catch (e) { showToast(`เกิดข้อผิดพลาด: ${e.message}`, 'error'); }
        };

        // --- MODAL FUNCTIONS (ADD/EDIT/DELETE) ---

        function showProjectModal(projectId = null) {
            const form = dom.form;
            form.reset();
            dom.formDeleteBtn.classList.add('hidden');
            
            if(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if(project) {
                    dom.modalTitle.textContent = "แก้ไขโปรเจค";
                    dom.formProjectId.value = project.id;
                    dom.formTitle.value = project.title;
                    dom.formCategory.value = project.category || "";
                    dom.formUrl.value = project.url || "";
                    dom.formDescription.value = project.description || "";
                    dom.formDeleteBtn.classList.remove('hidden');
                }
            } else {
                dom.modalTitle.textContent = "เพิ่มโปรเจคใหม่";
                dom.formProjectId.value = "";
            }
            
            dom.projectModalContainer.classList.remove('hidden');
        }

        function hideProjectModal() {
            dom.projectModalContainer.classList.add('hidden');
        }

        function handleSaveProject(event) {
            event.preventDefault();
            const form = dom.form;
            const id = dom.formProjectId.value;
            const projectData = {
                id: id || `p${Date.now()}`,
                title: dom.formTitle.value,
                category: dom.formCategory.value,
                url: dom.formUrl.value,
                description: dom.formDescription.value
            };

            if(id) { // Edit
                state.projects = state.projects.map(p => p.id === id ? projectData : p);
            } else { // Add
                state.projects.push(projectData);
            }
            
            sortProjects();
            saveProjectsToStorage();
            renderProjectList();
            hideProjectModal();
            triggerAutoSync(); // Auto-sync
        }

        function confirmDeleteProject(projectId) {
            let idToDelete = projectId || dom.formProjectId.value;
            if (!idToDelete) return;
            
            state.pendingDeleteId = idToDelete;
            dom.confirmModalContainer.classList.remove('hidden');
        }
        
        function hideConfirmModal() {
            state.pendingDeleteId = null;
            dom.confirmModalContainer.classList.add('hidden');
        }

        function executeDelete() {
            const id = state.pendingDeleteId;
            if (!id) return;
            
            state.projects = state.projects.filter(p => p.id !== id);
            saveProjectsToStorage();
            renderProjectList();
            
            hideConfirmModal();
            hideProjectModal(); 
            showToast('ลบโปรเจคสำเร็จ');
            triggerAutoSync(); // Auto-sync
        }
 
 
        // --- BACKUP & RESTORE ---
        
        function exportBackup() {
            const backupData = {
                projects: state.projects
            };
            const data = JSON.stringify(backupData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `project_repo_backup_${new Date().toLocaleDateString('sv-SE')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('กำลังดาวน์โหลดไฟล์สำรองข้อมูล');
        }
        
        function triggerImport() { dom.importFileInput.click(); }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.projects) {
                            state.projects = importedData.projects;
                        } else if (Array.isArray(importedData)) {
                            state.projects = importedData;
                        } else {
                            throw new Error('ไฟล์ไม่ถูกต้อง');
                        }

                        sortProjects();
                        saveProjectsToStorage();
                        
                        renderProjectList();
                        renderSettings(); 
                        switchView('view-projects'); 
                        
                        triggerAutoSync(); // Auto-sync
                    } catch (err) { showToast(`เกิดข้อผิดพลาด: ${err.message}`, 'error'); }
                };
                reader.readAsText(file);
            }
            event.target.value = null; 
        }
        
        // --- GOOGLE SHEET SYNC ---
        async function triggerAutoSync() {
            const url = dom.inputAppsScriptUrl.value;
            if (!url) return; 

            console.log("Auto-syncing to Google Sheet...");

            try {
                const payload = JSON.stringify(state.projects); // [ดัดแปลง]
                const response = await fetch(url, {
                    method: 'POST', mode: 'cors', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: payload
                });
                const result = await response.json();
                if (result.status === 'success') {
                    console.log(`Auto-sync successful: ${result.rows_synced} rows.`);
                } else {
                    throw new Error(result.message || "Unknown error from Apps Script");
                }
            } catch (error) {
                console.error("GSheet Auto-Sync Error:", error);
                showToast(`Auto-sync ล้มเหลว: ${error.message}`, 'error');
            }
        }

        // --- [ใหม่] AI CHAT FUNCTIONS ---

        // [ใหม่] Image Attachment
        function triggerImageUpload() {
            dom.imageUploadInput.click();
        }
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!['image/jpeg', 'image/png'].includes(file.type)) {
                showToast('รองรับเฉพาะไฟล์ .jpg หรือ .png เท่านั้น', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                const base64String = dataUrl.split(',')[1];
                state.attachedFile = { base64: base64String, mimeType: file.type, dataUrl: dataUrl };
                renderImagePreview();
            };
            reader.readAsDataURL(file);
        }
        function renderImagePreview() {
            dom.imagePreviewContainer.innerHTML = `
                <img src="${state.attachedFile.dataUrl}" alt="Preview" class="w-24 h-24 object-cover rounded-lg border border-slate-300">
                <button id="remove-image-btn" type="button" onclick="window.removeImagePreview()" class="absolute -top-2 -right-2 w-6 h-6 bg-slate-700 text-white rounded-full flex items-center justify-center border-2 border-white shadow-md"><i class="fa-solid fa-times text-xs"></i></button>
            `;
            dom.imagePreviewContainer.style.display = 'block';
        }
        function removeImagePreview() {
            state.attachedFile = { base64: null, mimeType: null, dataUrl: null };
            dom.imagePreviewContainer.innerHTML = '';
            dom.imagePreviewContainer.style.display = 'none';
            dom.imageUploadInput.value = null; 
        }

        // [ใหม่] Chat Rendering
        function renderChatHistory() {
            dom.chatMessageContainer.innerHTML = state.chatHistory.map(msg => {
                if (msg.role === 'user') {
                    return `<div class="chat-bubble chat-bubble-user">${escapeHTML(msg.text)}</div>`;
                } else {
                    // AI Message
                    const errorClass = msg.status === 'error' ? 'chat-bubble-ai-error' : '';
                    const icon = msg.status === 'error' ? 'fa-triangle-exclamation' : 'fa-robot';
                    
                    // [ใหม่] Format AI message (HTML, Code blocks)
                    const content = formatAIMessage(msg.text, msg.id, msg.status, msg.payload);
                    
                    return `<div class="chat-bubble chat-bubble-ai ${errorClass}">
                                <i class="fa-solid ${icon} fa-fw"></i>
                                <div class="chat-content">${content}</div>
                            </div>`;
                }
            }).join('');
            
            if (state.isAiThinking) {
                addTypingIndicator();
            }
            
            renderSuggestedPrompts(); // [ใหม่] Show/hide prompts
            scrollToChatBottom();
        }
        
        // [ใหม่] Format AI Message (Rich Content)
        function formatAIMessage(rawText, msgId, status, payload) {
            let html = rawText;

            // 1. Handle Error Status
            if (status === 'error') {
                html = `<p class="font-semibold">เกิดข้อผิดพลาด</p>
                        <p class="text-xs">${escapeHTML(rawText)}</p>
                        <button class="chat-retry-btn" onclick="window.retryAITask('${msgId}')">
                            <i class="fa-solid fa-rotate-right mr-1"></i> ลองใหม่
                        </button>`;
                // Store payload in the button if needed (but it's stored in state)
                return html;
            }

            // 2. Format Code Blocks ( ``` )
            html = html.replace(/```(.*?)\n([\s\S]*?)```/gs, (match, lang, code) => {
                const escapedCode = escapeHTML(code);
                const langTag = lang ? `<span class="text-xs text-slate-400">${lang.trim()}</span>` : '';
                return `<pre>
                            <button class="code-copy-btn" onclick="window.copyCode(this)">
                                <i class="fa-solid fa-copy"></i> คัดลอก
                            </button>
                            <code>${escapedCode}</code>
                        </pre>`;
            });

            // 3. AI is expected to send <b>, <ul>, <li> tags (from system prompt)
            // We are NOT escaping the HTML, so they render automatically.
            return html;
        }
        
        // [ใหม่] Copy Code Function
        window.copyCode = (buttonEl) => {
            const pre = buttonEl.closest('pre');
            const code = pre.querySelector('code').innerText;
            
            // Use fallback for clipboard
            const textArea = document.createElement("textarea");
            textArea.value = code;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                buttonEl.innerHTML = '<i class="fa-solid fa-check"></i> คัดลอกแล้ว';
                setTimeout(() => {
                    buttonEl.innerHTML = '<i class="fa-solid fa-copy"></i> คัดลอก';
                }, 2000);
            } catch (err) {
                showToast('ไม่สามารถคัดลอกได้', 'error');
            }
            document.body.removeChild(textArea);
        };
        
        // [ใหม่] Suggested Prompts
        function renderSuggestedPrompts() {
            if (state.chatHistory.length > 0 || state.isAiThinking) {
                dom.suggestedPromptsContainer.innerHTML = '';
                return;
            }
            
            const prompts = [
                { icon: "fa-plus", text: "เพิ่มโปรเจคใหม่ให้หน่อย" },
                { icon: "fa-list-check", text: "สรุปโปรเจคทั้งหมดที่มี" },
                { icon: "fa-search", text: "ค้นหาโปรเจคเกี่ยวกับ 'Tools'" },
                { icon: "fa-file-code", text: "ขอโค้ด Apps Script สำหรับ Sync" }
            ];

            dom.suggestedPromptsContainer.innerHTML = prompts.map(p => `
                <button class="suggested-prompt" onclick="window.runSuggestedPrompt('${p.text}')">
                    <i class="fa-solid ${p.icon} fa-fw"></i>
                    <span>${p.text}</span>
                </button>
            `).join('');
        }
        
        window.runSuggestedPrompt = (promptText) => {
            dom.chatInput.value = promptText;
            document.getElementById('chat-form').dispatchEvent(new Event('submit', { cancelable: true }));
        };

        // [ใหม่] Typing Indicator
        function addTypingIndicator() {
            if (document.getElementById('ai-typing-indicator')) return; 
            const bubble = document.createElement('div');
            bubble.id = 'ai-typing-indicator';
            bubble.className = 'chat-bubble chat-bubble-ai-typing';
            bubble.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
            dom.chatMessageContainer.appendChild(bubble);
            scrollToChatBottom();
        }
        function removeTypingIndicator() {
            const indicator = document.getElementById('ai-typing-indicator');
            if (indicator) indicator.remove();
        }
        
        function scrollToChatBottom() {
            dom.chatMessageContainer.scrollTop = dom.chatMessageContainer.scrollHeight;
        }

        // [ใหม่] Toggle Send/Stop buttons
        function toggleChatControls(isThinking) {
            state.isAiThinking = isThinking;
            
            dom.chatSendBtn.classList.toggle('hidden', isThinking);
            dom.chatStopBtn.classList.toggle('active', isThinking);
            
            dom.chatInput.disabled = isThinking; 
            dom.attachBtn.disabled = isThinking; 
            
            renderSuggestedPrompts(); // Hide prompts when thinking
        }
        
        // [ใหม่] Stop AI Generation
        function stopAIGeneration() {
            if (currentAIController) {
                currentAIController.abort();
                console.log("AI generation stopped by user.");
            }
            toggleChatControls(false);
            removeTypingIndicator();
        }

        // [ใหม่] Core AI Chat Logic (Refactored for Retry)
        async function sendChatMessage(event) {
            event.preventDefault();
            if (state.isAiThinking) return; 
            
            const userMessage = dom.chatInput.value.trim();
            if (!userMessage && !state.attachedFile.base64) return; 

            const apiKey = dom.inputApiKey.value;
            if (!apiKey) {
                showToast('กรุณากรอก API Key ก่อน', 'error');
                switchView('view-settings'); dom.inputApiKey.focus(); return;
            }

            toggleChatControls(true);
            
            dom.chatInput.value = '';
            dom.chatInput.style.height = 'auto'; 
            
            const messageId = 'msg-' + Date.now();
            const messagePayload = createAIPayload(userMessage); // [ใหม่] Helper
            
            addMessageToChat('user', userMessage || "(วิเคราะห์รูปภาพ)", { id: messageId }); 
            addTypingIndicator(); 
            
            // Execute the fetch
            await executeAIFetch(messagePayload, messageId);
        }
        
        // [ใหม่] Retry Logic
        window.retryAITask = async (errorMsgId) => {
            const errorMsg = state.chatHistory.find(m => m.id === errorMsgId);
            if (!errorMsg || !errorMsg.payload) {
                showToast('ไม่พบข้อมูลสำหรับ Retry', 'error');
                return;
            }
            
            const payloadToRetry = errorMsg.payload;
            
            // Remove the error message
            state.chatHistory = state.chatHistory.filter(m => m.id !== errorMsgId);
            
            toggleChatControls(true);
            renderChatHistory(); // Re-render without the error
            addTypingIndicator();
            
            await executeAIFetch(payloadToRetry, errorMsgId); // Reuse the original ID
        };
        
        // [ใหม่] Reusable Fetch Execution
        async function executeAIFetch(payload, messageId) {
            currentAIController = new AbortController();
            const model = dom.inputAiModel.value;
            const apiKey = dom.inputApiKey.value;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: currentAIController.signal // [ใหม่] Abort Signal
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error?.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                removeTypingIndicator(); 
                if (text) {
                    processAIResponse(text); 
                } else {
                    throw new Error("AI ไม่ได้ส่งข้อมูลกลับมา");
                }
                toggleChatControls(false);

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log("Fetch aborted");
                    return; // Stopped by user, not an error
                }
                
                console.error("AI Generation Error:", error);
                removeTypingIndicator(); 
                toggleChatControls(false);
                
                // [ใหม่] Add error message with payload for retry
                const errorId = 'err-' + messageId;
                addMessageToChat('ai', error.message, {
                    id: errorId,
                    status: 'error',
                    payload: payload // Store the failed payload
                });
            } finally {
                if (state.attachedFile.base64) {
                    removeImagePreview(); // Clear image after sending
                }
            }
        }
        
        // [ใหม่] Payload Creation Helper
        function createAIPayload(userMessage) {
            const today = new Date().toLocaleDateString('sv-SE');
            
            // [ใหม่] System Prompt (Rich Content)
            const systemPrompt = `
คุณคือ 'AI ผู้ช่วยคลังโปรเจค' (v3)
หน้าที่ของคุณคือจัดการคลังโปรเจค (JSON) และตอบคำถามทั่วไป

กฎการทำงาน:
1.  **ตระหนักรู้ข้อมูล:**
    * วันนี้คือ: ${today}
    * ข้อมูลโปรเจคปัจจุบัน: ${JSON.stringify(state.projects)}
2.  **สั่งการ (Mutate):** หากผู้ใช้ "เพิ่ม", "ลบ", "แก้ไข" โปรเจค คุณต้องตอบกลับเป็น **JSON Array (ข้อมูลโปรเจคใหม่)** ที่สมบูรณ์เท่านั้น
    * ห้ามมีข้อความอื่น ห้ามมี markdown (เช่น \`\`\`json)
    * 'id' ต้องเป็น String (เช่น 'p12345')
3.  **ตอบคำถาม (Query):** หากผู้ใช้ "ถาม" หรือ "ค้นหา"
    * คุณต้องตอบกลับเป็น **JSON Object ที่มี key "answer"**
    * Ex: { "answer": "ฉันพบ 3 โปรเจคที่ตรงกัน..." }
4.  **การจัดรูปแบบ (Rich Content):**
    * ใน "answer" คุณสามารถใช้ HTML Tags ต่อไปนี้ได้: <b>, <ul>, <li>
    * เมื่อต้องการแสดงโค้ด ให้ใช้ \`\`\`(language)\n(code)\n\`\`\`
5.  **ค้นหา:** หากผู้ใช้ถามคำถามทั่วไป (เช่น "วิธีทำ...", "โค้ด Apps Script") ให้ใช้ Google Search
`;
            
            const userQuery = `คำสั่งจากผู้ใช้: "${userMessage}"`;
            
            const parts = [{ text: userQuery }];
            if (state.attachedFile.base64 && state.attachedFile.mimeType) {
                parts.push({
                    inlineData: {
                        mimeType: state.attachedFile.mimeType,
                        data: state.attachedFile.base64
                    }
                });
            }

            return {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: parts }],
                tools: [{ "google_search": {} }] 
            };
        }

        // [ใหม่] Add Message to Chat (with options)
        function addMessageToChat(role, text, options = {}) {
            const msg = {
                role: role,
                text: text,
                id: options.id || 'msg-' + Date.now() + Math.random(),
                status: options.status || 'ok',
                payload: options.payload || null // For retry
            };
            
            state.chatHistory.push(msg);
            saveChatHistory();
            renderChatHistory(); 
        }

        function processAIResponse(jsonString) {
            try {
                const cleanJsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
                const aiData = JSON.parse(cleanJsonString);
                
                if (Array.isArray(aiData)) { // 2. สั่งการ (Mutate)
                    const oldLength = state.projects.length;
                    const newLength = aiData.length;
                    state.projects = aiData; 
                    
                    sortProjects();
                    saveProjectsToStorage();
                    
                    let summaryMsg = "ดำเนินการเรียบร้อยค่ะ";
                    if (newLength > oldLength) {
                        summaryMsg = `ฉันเพิ่ม ${newLength - oldLength} โปรเจค และอัปเดตข้อมูลให้แล้วค่ะ`;
                    } else if (newLength < oldLength) {
                        summaryMsg = `ฉันลบ ${oldLength - newLength} โปรเจค และอัปเดตข้อมูลให้แล้วค่ะ`;
                    } else if (oldLength === newLength && oldLength > 0) {
                        summaryMsg = "ฉันอัปเดตข้อมูลโปรเจคให้แล้วค่ะ";
                    }

                    addMessageToChat('ai', summaryMsg); // ตอบกลับแบบปกติ
                    showToast(summaryMsg, 'success');
                    
                    renderProjectList();
                    triggerAutoSync(); // Auto-sync

                } else if (typeof aiData === 'object' && aiData !== null && aiData.answer) { // 3. ตอบคำถาม (Query)
                    const answer = aiData.answer;
                    addMessageToChat('ai', answer);
                    
                } else {
                    throw new Error("AI response is not a valid Array or Answer Object.");
                }
            } catch (error) {
                console.error("AI Response Parse Error:", error);
                const errorMsg = `AI Error: ${error.message} (AI ตอบกลับ: ${jsonString})`;
                // Add as a simple text message, not an error state
                addMessageToChat('ai', errorMsg);
                showToast('AI ตอบกลับในรูปแบบที่ผิดพลาด', 'error');
            }
        }

        // --- Window Attachments ---
        window.switchView = switchView;
        window.renderProjectList = renderProjectList;
        window.saveAppsScriptUrl = saveAppsScriptUrl;
        window.saveApiKey = saveApiKey;
        window.toggleKeyVisibility = toggleKeyVisibility;
        window.saveAiModel = saveAiModel;
        window.saveProjectsDataFromJson = saveProjectsDataFromJson;
        window.showProjectModal = showProjectModal;
        window.hideProjectModal = hideProjectModal;
        window.handleSaveProject = handleSaveProject;
        window.confirmDeleteProject = confirmDeleteProject;
        window.hideConfirmModal = hideConfirmModal;
        window.executeDelete = executeDelete;
        window.exportBackup = exportBackup;
        window.triggerImport = triggerImport;
        window.handleFileImport = handleFileImport;
        window.triggerAutoSync = triggerAutoSync;
        window.triggerImageUpload = triggerImageUpload;
        window.handleImageUpload = handleImageUpload;
        window.removeImagePreview = removeImagePreview;
        window.runSuggestedPrompt = runSuggestedPrompt; // [ใหม่]
        window.copyCode = copyCode; // [ใหม่]
        window.retryAITask = retryAITask; // [ใหม่]

        // --- Start App ---
        initApp();
    </script>
</body>
</html>
